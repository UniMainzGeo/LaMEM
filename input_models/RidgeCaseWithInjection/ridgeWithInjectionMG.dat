# 2D Ridge setup with diking
# howellsm 2016

nel_x						=   161
nel_y						= 	61
nel_z						= 	61
 
# Geometry
units 						= 	geo
Characteristic.Length		=	1e4 		# [m]
Characteristic.Viscosity 	=	1e20		# [Pa.s]
Characteristic.Temperature	=	1			# [K]
Characteristic.Stress      	=   1e6			# [Pa]

W							=	80			# Width  (x-direction)
L							=	30			# Length (y-direction)
H							=	30			# Height (z-direction)

x_left						=	-40			# Left side of domain
y_front						=	0			# Front side of domain
z_bot						=	0			# Bottom of box

# --- Model setup and noise ---
msetup 						= 	ridge		# Shear band setup, which has additional command-line options 

# Define input/output and numerics-related stuff
OutputFile					=	ridgeWithInjectionMG		

# Timestepping options
save_timesteps				=	10				# save every ? timesteps
save_breakpoints 			=	0				# don't save breakpoints
time_end					=	3001			# last timestep
CFL							=	0.5				# CFL, dt-based criterium
dt_max						=	0.005 	  	   	# Maximum timestep [Myr if dimensional]
	
# Boundary conditions
BC.LeftBound				=	1				# 0 - free surface, 1-free slip with BG strainrate Eyy, 
BC.RightBound				=	1				# 0 - free surface, 1-free slip with BG strainrate Eyy, 
BC.FrontBound				=	1				# 0 - free surface, 1-free slip with BG strainrate Exx, 
BC.BackBound				=	1				# 0 - free surface, 1-free slip with BG strainrate Exx, 
BC.LowerBound				=	1				# 0 - free surface, 1-free slip, 				  2 - no slip, 5 - growthrate 2D, 7 - growthrate 3D
BC.UpperBound				=	1				# 0 - free surface, 1-free slip, 				  2 - no slip, 5 - growthrate 2D, 7 - growthrate 3D
Temp_top	    			=   0				# Temperature @ top
Temp_bottom					=   0 				# Temperature @ bottom; side BC's are flux-free


<PetscOptionsStart>
	-open_top_bound 1
	-use_marker_control 1
	-new_advection
	-advection 2
	-velinterp 2
	-markers_min 5
	-ad_nmin 5

	# Internal free surface
	-FSSA 				1.0
	-surf_use        	1
	-surf_level      	20
	-surf_air_phase 	2

	# Dampening for plasticity
	-use_quasi_harmonic_viscosity
	-cf_eta_min 50					# dampening plasticity viscosity: requires tuning!
	
	# Define ridge setup geometry - howellsm
	#        L_axis 
	# _________|_________ 
	#         ___ <- thickness H_lith 
	#        /   \ <--- slopes according to L_double
	#    ___/     \___
	# __/             \__ <--- slopes according to L_double / L_damp
	#       |-| <- L_trough 
	#		  |--| <- L_notch
	# ENSURE that -surf_level = H_lith + H_asth
	-Ridge.On   	1       # ridge flag
	-Ridge.Enforce  1 		# Enforce ridge on markers each timestep
	-Ridge.Heal     1       # Heal APS according to timescale tauheal
	-tauHeal		0.9    # Plastic healing timescale
	-Ridge.Vx   	2.0     # 1/2 spreading rate, [cm/yr]
	-Ridge.H_lith 	6.0		# Lithosphere thickness at ridge axis
	-Ridge.H_asth   14.0    # Asthenosphere thickness below axis
	-Ridge.L_axis 	0.0 	# x-location of axis (center would be W/2 + x_left)	
	-Ridge.L_double 13.3	# Distance from H to 2H (km)
	-Ridge.L_notch 	0.0	 	# Width of flat isotherm beneath axis (km)
	-Ridge.L_trough 20.0 	# Total width of inverted trough = L_notch + 2 x L_trough (km)
	-Ridge.L_damp   1000.0    # factor to reduce slope by outside trough


	# Diking Parameters - TO be used with RIDGE case - howellsm (no variable grid)
	-Dike.on    1    # turn on diking
	-Dike.xDike 0.0  # x-location of dike (center would be W/2 + x_left)
	-Dike.M     1.0  # Fraction of magmatic extension

	# SNES
	-npicard 3
	-snes_monitor
	-snes_atol 1e-12
	-snes_rtol 1e-6
	-snes_stol 1e-6
	-snes_max_it 25
	-snes_max_funcs 50000
	-snes_type 		ksponly

	# Jacobian KSP
	-js_ksp_type gcr
	-js_ksp_max_it 1000
	-js_ksp_min_it 2
	-js_ksp_converged_reason
 	-js_ksp_monitor
	-js_ksp_rtol 1e-8

	# Stokes Preconditioner
	-pstokes mg

	# Augmented Lagrangian
	-pgamma 1e3
	-al_ksp_type preonly
	-al_pc_type lu
	-al_pc_factor_mat_solver_package mumps

	# MULTIGRID
	-gmg_pc_type mg
	-gmg_pc_mg_levels 4
	-gmg_pc_mg_galerkin
	-gmg_pc_mg_type multiplicative
	-gmg_pc_mg_cycle_type v
	-gmg_pc_view 
	-gmg_pc_mg_log		# monitors time spend in multigrid if using -log_summary
	
	-gmg_mg_levels_ksp_type richardson
	
	-gmg_mg_levels_ksp_richardson_scale 0.5
	-gmg_mg_levels_ksp_max_it 20
	
	# use GAMG as a coarse grid solver (scales better in parallel and has redistribution)
	-crs_ksp_type preonly
	-crs_pc_type gamg -
	-crs_pc_gamg_sym_graph true 
	-crs_pc_gamg_agg_nsmooths 0 
	-crs_pc_gamg_verbose 1 
	-crs_pc_gamg_repartition true 

	# Fine-tune solver options here (add command-line Petsc Options)
	-use_fdstag_canonical

<PetscOptionsEnd>
    
# Phase distribution
NumPartX				=	5   # Particles/Cell in x-direction
NumPartY				=	5   # Particles/Cell in y-direction
NumPartZ				=	5	# Particles/Cell in z-direction

# Properties that are defined over the whole domain:
Gravity					=  -9.8;									# [m/s2] - gravitational acceleration 

LowerViscosityCutoff	= 1e16
UpperViscosityCutoff	= 1e27
#PlastViscosity          = 1e19
DII_ref                 = 1e-16


# Define material properties for all phases -------------------------------------------------

	# Define properties of bottom layer -------------------
	<MaterialStart>
		ID   = 0
		rho0 = 2900
		eta  = 1e18
	<MaterialEnd>

	# Define properties of matrix -----------------
	<MaterialStart>
		ID       = 1
		rho0     = 2900
		eta      = 1e24
		shear    = 40e9
		cohesion = 30e6
		friction = 30
		chSoftID = 0
		frSoftID = 0
	<MaterialEnd>

	# Define properties of sticky-air layer -------------------
	<MaterialStart>
		ID   = 2
		rho0 = 1000
		eta  = 1e17
	<MaterialEnd>

	# Define strain softening law
	<SofteningStart>
		softID = 0
		A      = 0.9
		APS1   = 0.05
		APS2   = 0.2
	<SofteningEnd>

# End of defining material properties for all phases ----------------------------------------
