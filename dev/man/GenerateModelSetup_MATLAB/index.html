<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>3.2 Generating a model setup from MATLAB/Octave · LaMEM</title><meta name="title" content="3.2 Generating a model setup from MATLAB/Octave · LaMEM"/><meta property="og:title" content="3.2 Generating a model setup from MATLAB/Octave · LaMEM"/><meta property="twitter:title" content="3.2 Generating a model setup from MATLAB/Octave · LaMEM"/><meta name="description" content="Documentation for LaMEM."/><meta property="og:description" content="Documentation for LaMEM."/><meta property="twitter:description" content="Documentation for LaMEM."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../Home/">LaMEM</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../Home/">Home</a></li><li><a class="tocitem" href="../Quickstart/">Quick start</a></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../Installation/">Installation</a></li><li><a class="tocitem" href="../GettingStarted/">Getting Started</a></li><li><a class="tocitem" href="../InitialModelSetup/">Initial Model setup</a></li></ul></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../LaMEM_Development/">LaMEM Development</a></li><li><a class="tocitem" href="../Debugging/">LaMEM Debugging</a></li></ul></li><li><a class="tocitem" href="../CODE_OF_CONDUCT/">Code of conduct</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>3.2 Generating a model setup from MATLAB/Octave</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>3.2 Generating a model setup from MATLAB/Octave</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/UniMainzGeo/LaMEM" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/UniMainzGeo/LaMEM/blob/master/docs/src/man/GenerateModelSetup_MATLAB.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><p>[TOC]</p><h1 id="3.2-Generating-a-model-setup-from-MATLAB/Octave"><a class="docs-heading-anchor" href="#3.2-Generating-a-model-setup-from-MATLAB/Octave">3.2 Generating a model setup from MATLAB/Octave</a><a id="3.2-Generating-a-model-setup-from-MATLAB/Octave-1"></a><a class="docs-heading-anchor-permalink" href="#3.2-Generating-a-model-setup-from-MATLAB/Octave" title="Permalink"></a></h1><p>In many cases, generating a model setup from within the LaMEM input file using build-in geometries is insufficient and we would like to have more control on what we are doing &amp; create more complicated setups.</p><p>One way to do this is to use a MATLAB/Octave script to generate the model setup. We have provided example files in <code>/input_models/SubductionWithParticles/</code>, as well as in some of the test directories.</p><p>Depending on whether your LaMEM simulation will run in parallel or not there are two different approaches: </p><ol><li><p>Create the full setup on one processor. For this, the matlab scripts should be placed in the same directory as the LaMEM <code>(*.dat)</code> input script. </p></li><li><p>By creating a <code>parallel partitioning file</code> which allows creating a parallel input file. With this method, every processor of a parallel LaMEM simulation only reads in the piece of the input geometry it needs. This method is scalable to very high resolutions, but requires you to run LaMEM first to create the partitioning file.   </p></li></ol><p>If you start with a new setup/project, we recommend that you first generate the input file on one processor, and look at it using Paraview (approach 1). Once you are happy with it, you can proceed with approach 2.</p><p>Let&#39;s have a look at how these two approaches work, using the input files in <code>/input_files/SubductionWithParticles</code> as an example.</p><p>The files in this directory create a setup for a subduction model with free slip and no temperature (first case) or with temperature-dependent properties (second example).</p><h3 id="3.2.1.-Generate-the-input-on-a-single-processor"><a class="docs-heading-anchor" href="#3.2.1.-Generate-the-input-on-a-single-processor">3.2.1. Generate the input on a single processor</a><a id="3.2.1.-Generate-the-input-on-a-single-processor-1"></a><a class="docs-heading-anchor-permalink" href="#3.2.1.-Generate-the-input-on-a-single-processor" title="Permalink"></a></h3><p>The file <code>CreateMarkers_Subduction_Linear_FreeSlip_parallel.m</code> gives an example of how we can generate an input file on one processor.</p><p>At the beginning we need to set the directories such that MATLAB/Octave knowns where the matlab scripts are that it needs:</p><pre><code class="nohighlight hljs">addpath(&#39;../../matlab&#39;)</code></pre><p>This may have to be changed if you are in a different directory.</p><p>To generate the setup on one processor, please make sure that the following flag is set to zero:</p><pre><code class="nohighlight hljs">LaMEM_Parallel_output  =    0;</code></pre><p>You also need to specify the LaMEM input file with:</p><pre><code class="nohighlight hljs">LaMEM_input_file        =   &#39;Subduction2D_FreeSlip_MATLABParticles_Linear_DirectSolver.dat&#39;;</code></pre><p>Once this is done, it reads the LaMEM input file to figure out the size of the computational domain, the number of elements employed in every direction as well as the number of particles in every direction. It also generates a 3D grid, which is all done with this function:</p><pre><code class="nohighlight hljs">[Grid,X,Y,Z,npart_x,npart_y,npart_z,W,L,H] =   LaMEM_ParseInputFile(LaMEM_input_file);</code></pre><p>You can use the <code>X,Y,Z</code> grid later to create your input geometry. Within the MATLAB script, the following 3D arrays are created:</p><pre><code class="nohighlight hljs">Phase : contains the phase or rock-type at every point in the grid 
Temp  : contains the temperature in degrees Celcius @ every point in the grid</code></pre><p>After reading the dimensions of the grid, we use various ways to create the setup. </p><p>In this specific example, we actually generate a polygon and use the command <code>inpolygon</code> to figure out which of the 3D points are located within the polygon to specify where the slab is.  At the end of the file, we save the markers to disk with</p><pre><code class="nohighlight hljs">FDSTAGSaveMarkersParallelMatlab(A,Parallel_partition);</code></pre><p>which will put the marker files in the directory <code>/markers</code>.  Within the LaMEM input file, you indicate that this directory should be used with</p><pre><code class="nohighlight hljs">msetup          =   files            
mark_load_file  =   ./markers/mdb     # marker input file (extension is .xxxxxxxx.dat)</code></pre><p>Moreover, we also create a 3D output file <code>VTK_ModelSetup_paraview_binary.vtr</code> that we can open with Paraview:</p><pre><code class="nohighlight hljs">FDSTAGWriteMatlab2VTK(A,&#39;BINARY&#39;); % default option</code></pre><p>Doing that is useful as it allows you to build the setup without having to run the LaMEM model.</p><p>Once you are happy, you can run LaMEM on one processor with</p><pre><code class="nohighlight hljs">../../bin/opt/LaMEM -ParamFile Subduction2D_FreeSlip_Particles_Linear_DirectSolver.dat</code></pre><p>Interested in how to do the same on &gt;1 processor?  Keep on reading...</p><h3 id="3.2.2.-Generating-parallel-input-using-partitioning-files"><a class="docs-heading-anchor" href="#3.2.2.-Generating-parallel-input-using-partitioning-files">3.2.2. Generating parallel input using partitioning files</a><a id="3.2.2.-Generating-parallel-input-using-partitioning-files-1"></a><a class="docs-heading-anchor-permalink" href="#3.2.2.-Generating-parallel-input-using-partitioning-files" title="Permalink"></a></h3><p>Generating parallel input files involves 3 steps:</p><ol><li>Create a <strong>ProcessorPartitioning</strong> file for a specific number of processors, which basically tells how LaMEM divides the computational box over the various processors.</li><li>Run the MATLAB script that generates the input geometry file, using this <strong>ProcessorPartitioning</strong> file as input. In this case, you will have set the option <code>LaMEM_Parallel_output = 1</code> in the MATLAV script.</li><li>Run the LaMEM simulation in parallel, using the same number of processors as used to create the partitioning file.  </li></ol><p>In the following we will describe the 3 steps with an example. We will assume that you are happy with generating the setup on one processor (see above). The matlab example file we will be using is</p><pre><code class="nohighlight hljs">/input_models/SubductionWithParticles/CreateMarkers_Subduction_Tdependent_FreeSurface_parallel.m</code></pre><h4 id="3.2.2.1-Create-the-partitioning-file"><a class="docs-heading-anchor" href="#3.2.2.1-Create-the-partitioning-file">3.2.2.1 Create the partitioning file</a><a id="3.2.2.1-Create-the-partitioning-file-1"></a><a class="docs-heading-anchor-permalink" href="#3.2.2.1-Create-the-partitioning-file" title="Permalink"></a></h4><p>Make sure that you are in the correct directory:</p><pre><code class="nohighlight hljs">$ cd /input_models/SubductionWithParticles
$ ls
CreateMarkers_Subduction_Linear_FreeSlip_parallel.m                     Subduction2D_FreeSurface_MATLABParticles_Nonlinear_DirectSolver.dat
CreateMarkers_Subduction_Tdependent_FreeSurface_parallel.m              Subduction3D_FreeSlip_MATLABParticles_Linear_Multigrid.dat
Makefile                                                                Tests
README                                                                  p_poly_dist.m
Subduction2D_FreeSlip_Particles_Linear_DirectSolver.dat</code></pre><p>We will use the file Subduction2D<em>FreeSurface</em>MATLABParticles<em>Nonlinear</em>DirectSolver.dat as LaMEM file.</p><p>First, run this file with LaMEM, but with the added command-line parameter <code>-mode save_grid</code></p><pre><code class="nohighlight hljs">$ mpiexec -n 4 ../../bin/opt/LaMEM -ParamFile Subduction2D_FreeSurface_MATLABParticles_Nonlinear_DirectSolver.dat -mode save_grid</code></pre><p>This will generate a processor partitioning file as follows:</p><pre><code class="nohighlight hljs">$ mpiexec -n 4 ../../bin/opt/LaMEM -ParamFile Subduction2D_FreeSurface_MATLABParticles_Nonlinear_DirectSolver.dat -mode save_grid
-------------------------------------------------------------------------- 
                   Lithosphere and Mantle Evolution Model                   
     Compiled: Date: Oct 25 2020 - Time: 14:02:58           
-------------------------------------------------------------------------- 
        STAGGERED-GRID FINITE DIFFERENCE CANONICAL IMPLEMENTATION           
-------------------------------------------------------------------------- 
Parsing input file : Subduction2D_FreeSurface_MATLABParticles_Nonlinear_DirectSolver.dat 
   Adding PETSc option: -snes_ksp_ew
   Adding PETSc option: -js_ksp_monitor
Finished parsing input file : Subduction2D_FreeSurface_MATLABParticles_Nonlinear_DirectSolver.dat 
--------------------------------------------------------------------------
Scaling parameters:
   Temperature : 1000. [C/K] 
   Length      : 1000. [m] 
   Viscosity   : 1e+20 [Pa*s] 
   Stress      : 1e+09 [Pa] 
--------------------------------------------------------------------------
Grid parameters:
   Total number of cpu                  : 4 
   Processor grid  [nx, ny, nz]         : [4, 1, 1]
   Fine grid cells [nx, ny, nz]         : [256, 2, 64]
   Number of cells                      :  32768
   Number of faces                      :  115328
   Maximum cell aspect ratio            :  1.17188
   Lower coordinate bounds [bx, by, bz] : [-1500., -10., -660.]
   Upper coordinate bounds [ex, ey, ez] : [1500., 10., 40.]
--------------------------------------------------------------------------
Saving processor partitioning ... done (0.000728846 sec)
--------------------------------------------------------------------------</code></pre><p>If you look again at the content of the directory, you will see that a new file is generated:</p><pre><code class="nohighlight hljs">$ ls
CreateMarkers_Subduction_Linear_FreeSlip_parallel.m                     Subduction2D_FreeSlip_Particles_Linear_DirectSolver.dat
CreateMarkers_Subduction_Tdependent_FreeSurface_parallel.m              Subduction2D_FreeSurface_MATLABParticles_Nonlinear_DirectSolver.dat
Makefile                                                                Subduction3D_FreeSlip_MATLABParticles_Linear_Multigrid.dat
ProcessorPartitioning_4cpu_4.1.1.bin                                    Tests
README                                                                  p_poly_dist.m</code></pre><p><code>ProcessorPartitioning_4cpu_4.1.1.bin</code> is the processor partitioning file, which we need to indicate in the matlab/octave script. If you generate the file on a different number of processors, or use different box-sizes, the naming of the partitioning file will be different. Note that on linux, you can always get info about the date when a file was added with:</p><pre><code class="nohighlight hljs">$ ls -al Proc*
-rw-r--r--  1 kausb  admin  2668 Oct 26 15:56 ProcessorPartitioning_4cpu_4.1.1.bin</code></pre><p>This will allow you to see which partitioning file was added most recently.</p><h4 id="3.2.2.2-Run-the-MATLAB/Octave-script"><a class="docs-heading-anchor" href="#3.2.2.2-Run-the-MATLAB/Octave-script">3.2.2.2 Run the MATLAB/Octave script</a><a id="3.2.2.2-Run-the-MATLAB/Octave-script-1"></a><a class="docs-heading-anchor-permalink" href="#3.2.2.2-Run-the-MATLAB/Octave-script" title="Permalink"></a></h4><p>Next, open the file <code>CreateMarkers_Subduction_Tdependent_FreeSurface_parallel.m</code> and make sure that the following parameters are activated/set:</p><pre><code class="nohighlight hljs">LaMEM_Parallel_output   =    1;
LaMEM_input_file        =   &#39;Subduction2D_FreeSurface_MATLABParticles_Nonlinear_DirectSolver.dat&#39;;
Parallel_partition      =   &#39;ProcessorPartitioning_4cpu_4.1.1.bin&#39;</code></pre><p>Once you run this file in MATLAB or Octave, it should give the following output:</p><pre><code class="nohighlight hljs">&gt;&gt; CreateMarkers_Subduction_Tdependent_FreeSurface_parallel
Creating setup in parallel using LaMEM file: Subduction2D_FreeSurface_MATLABParticles_Nonlinear_DirectSolver.dat

Parallel_partition =

    &#39;ProcessorPartitioning_4cpu_4.1.1.bin&#39;

Writing Appended data for binary output in Paraview ... 
Writing file -&gt; ./markers/mdb.00000000.dat
Writing file -&gt; ./markers/mdb.00000001.dat
Writing file -&gt; ./markers/mdb.00000002.dat
Writing file -&gt; ./markers/mdb.00000003.dat</code></pre><p>which shows that it created marker files for 4 processors.</p><p>If you open the file <code>VTK_ModelSetup_paraview_binary.vtr</code> in Paraview, it should look like:</p><p><img src="../../assets/img/Matlab_Input_Setup.png" alt="FinalSetup"/></p><p>Which is a subduction setup as in the example before, but this time with a halfspace cooling thermal age. </p><h4 id="3.2.2.3-Perform-the-parallel-LaMEM-simulation"><a class="docs-heading-anchor" href="#3.2.2.3-Perform-the-parallel-LaMEM-simulation">3.2.2.3 Perform the parallel LaMEM simulation</a><a id="3.2.2.3-Perform-the-parallel-LaMEM-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#3.2.2.3-Perform-the-parallel-LaMEM-simulation" title="Permalink"></a></h4><p>Once you successfully created the marker files, you can run the LaMEM simulation in parallel with:</p><pre><code class="nohighlight hljs">mpiexec -n 4 ../../bin/opt/LaMEM -ParamFile Subduction2D_FreeSurface_MATLABParticles_Nonlinear_DirectSolver.dat</code></pre><p>Please remember that you need to re-generate the partitioning file if you:</p><ol><li>Change the number of elements in any of the directions</li><li>Change the number of particles/element</li><li>Change the dimensions of the grid (length, width, bottom, etc.)</li></ol><p>If you only change the internal geometry or, say, the temperature of the slab, you do <strong>not</strong> need to redo the partitioning file. Simply rerunning the matlab script is ok in that case. </p><h3 id="3.2.3.-Understanding-the-input-scripts"><a class="docs-heading-anchor" href="#3.2.3.-Understanding-the-input-scripts">3.2.3. Understanding the input scripts</a><a id="3.2.3.-Understanding-the-input-scripts-1"></a><a class="docs-heading-anchor-permalink" href="#3.2.3.-Understanding-the-input-scripts" title="Permalink"></a></h3><p>The MATLAB/Octave input scripts consists of several parts.</p><p>In the beginning you specify the filenames, whether the input should be in parallel or not and (if applicable) the name of the partitioning file (all in red): </p><p><img src="../../assets/img/MatlabOctave_Script_Part1.png" alt="Script_Part1"/></p><p>In the next part, the user can do whatever to set the initial geometry. In this particular example, we create a 2D array that computes the distance of a point to the top of the slab. We also create a 2D polygon that described the slab but is set to <code>NaN</code> outside. </p><p><img src="../../assets/img/MatlabOctave_Script_Part2.png" alt="Script_Part2"/></p><p>The following part first defines the <code>Phase</code> and <code>Temp</code> 3D arrays, and sets the phases based on the distance towards the top of the slab. We use a halfspace cooling temperature profile with a thermal age of 50 Myrs in this case.</p><p><img src="../../assets/img/MatlabOctave_Script_Part3.png" alt="Script_Part3"/></p><p>In other scripts you will always have to define and set the properties of these two 3D arrays in one way or the other (how you do it, is up to you).</p><p>Finally, we save the data to LaMEM marker files and write a VTK output file:</p><p><img src="../../assets/img/MatlabOctave_Script_Part4.png" alt="Script_Part4"/></p><p>This last part is the same for all scripts and should not be modified.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Friday 31 October 2025 12:44">Friday 31 October 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
