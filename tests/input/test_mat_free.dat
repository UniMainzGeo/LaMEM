# 3D Folding/localization test

# Grid
nel_x =  128
nel_y =  2
nel_z =  48

# Geometry

W      =  40    # Width  (x-direction)
H      =  15    # Height (z-direction)
x_left = -20    # Left side of domain
y_front = 0     # Front side of domain
z_bot   = 0     # Bottom of box
L       = 0.625 # Length (y-direction)

# Characteristic values
units                      = geo
Characteristic.Length      = 1e4  # [m]
Characteristic.Viscosity   = 1e20 # [Pa.s]
Characteristic.Temperature = 1    # [K]
Characteristic.Stress      = 1e6  # [Pa]


# Model setup
msetup = bands


# Time stepping and output
OutputFile					=	test_vep
save_timesteps				=	1				# save every ? timesteps
time_end					=	50				# last timestep
CFL							=	0.1			# CFL, dt-based criterium
dt_max						=	3e-3  			# Maximum timestep [Myr if dimensional]


# Boundary conditions
Temp_top	    			=   0				# Temperature @ top
Temp_bottom					=   0 				# Temperature @ bottom; side BC's are flux-free
Gravity						=  -10;				=# [m/s2] - gravitational acceleration


# Control parameters
LowerViscosityCutoff = 1e16
UpperViscosityCutoff = 1e27
DII_ref              = 1e-15
FSSA                 = 1.0
InitViscosity        = 1e20

    
# Phase distribution
NumPartX				=	5   # Particles/Cell in x-direction
NumPartY				=	5   # Particles/Cell in y-direction
NumPartZ				=	5	# Particles/Cell in z-direction

#===============================================================================
# ............................... PETSc options.................................
#===============================================================================

<PetscOptionsStart>

	# matrix-free closed-form Jacobian
	-jac_mat_free

	# Background strain rate
	-ExxNumPeriods  1
	-ExxStrainRates -1e-15

	# Time step (Myr)
	-dt 1.5e-3

	# shear bands setup
	-H_layer 		  10
	-H_bottom 		  0
	-Inclusion_use
	-Inclusion_size	  1
	
#	-Inclusion_offset 10
#	-Inclusion_length 10


	# SNES (nonlinear) options
#	-snes_ksp_ew			# Eisenstat Walker algorithm
	-snes_npicard 2			# 2 picard iterations @ beginning of ever timestep
	-snes_monitor
	-snes_atol 1e-10
	-snes_rtol 1e-4
	-snes_stol 1e-16
	-snes_max_it 50
	-snes_max_funcs 500000
	-snes_max_linear_solve_fail 10000
	
	#-snes_type ksponly

	# Newton/picard options
	-snes_PicardSwitchToNewton_rtol 1e-1 		# relative tolerance to switch to Newton (1e-2)
	-snes_NewtonSwitchToPicard_it  	20		# number of Newton iterations after which we switch back to Picard
	-snes_NewtonSwitchToPicard_rtol 1.1		# relative tolerance compared to first iteration step

	# Linesearch options
	-snes_linesearch_monitor
	-snes_linesearch_type l2 				#Linesearch type (one of) shell basic l2 bt cp (SNESLineSearchSetType)  [l2 seems to work better with VEP]
	-snes_linesearch_maxstep 1.0			# very important to prevent the code from "blowing up"

#	-snes_linesearch_precheck_picard	#doesn't seem to bring much
#	-snes_linesearch_keeplambda
#	-snes_linesearch_damping  0.5


	# Jacobian solver
	-js_ksp_type fgmres
	-js_ksp_max_it 100
	-js_ksp_converged_reason
#	-js_ksp_monitor
	-js_ksp_rtol 1e-6
	-js_ksp_atol 1e-6


	# Preconditioner
	-pcmat_type mono
	-pcmat_pgamma 1e3
	-jp_type user
	-jp_pc_type lu
	-jp_pc_factor_mat_solver_package mumps

#	-pcmat_type block
#	-pcmat_pgamma 10.0
#	-jp_type bf
#	-bf_vs_type user
#	-vs_ksp_type preonly
#	-vs_pc_type lu
#	-vs_pc_factor_mat_solver_package mumps

#	-pcmat_type block
#	-pcmat_no_dev_proj
#	-jp_type bf
#	-bf_vs_type mg
#	-vs_ksp_type preonly

#	-pcmat_type mono
#	-jp_type mg

#	-gmg_pc_view
#	-gmg_pc_type mg
#	-gmg_pc_mg_levels 2
#	-gmg_pc_mg_galerkin
#	-gmg_pc_mg_type multiplicative
#	-gmg_pc_mg_cycle_type v
#
#	-gmg_mg_levels_ksp_type richardson
#	-gmg_mg_levels_ksp_richardson_scale 0.5
#	-gmg_mg_levels_ksp_max_it 20
#	-gmg_mg_levels_pc_type jacobi
#
#	-crs_ksp_type preonly
#	-crs_pc_type redundant
#	-crs_pc_redundant_number 1
#	-crs_redundant_pc_factor_mat_solver_package mumps


	# Additional command-line Petsc Options
	-AddRandomNoiseParticles 0
	-restart 0
	-save_breakpoints 0
	-objects_dump
	-restart 0
#	-SkipStokesSolver 1
#	-SavePartitioning
#	-skip_press_shift

	# output
	-out_pvd 1
	-out_phase 1
	-out_density 1
	-out_viscosity 1
	-out_velocity 1
	-out_pressure 1
	-out_temperature 1#
	-out_dev_stress 1
	-out_j2_dev_stress 1
	-out_strain_rate 1
	-out_j2_strain_rate 1
	-out_plast_strain 1
	-out_plast_strain 1
	-out_moment_res 1
	-out_cont_res 1

	-AVDPhaseViewer 0


<PetscOptionsEnd>

#===============================================================================
# ............................ Material Parameters .............................
#===============================================================================

	# Strain softening parameters
	<SofteningStart>
		softID = 0
		A      = 0.5
		APS1   = 0.001
		APS2   = 0.1
	<SofteningEnd>


	# Bottom layer
	<MaterialStart>
		ID              = 0     # phase id  [-]
		rho0            = 3000	# density - if dimensional [kg/m3]
		eta             = 1e22	# Viscosity - dimensional [Pa.s]
		shear           =  5e10
		cohesion        =  20e6
		friction        =  30
		frSoftID        =  0 # softening ID
		chSoftID        =  0
	<MaterialEnd>


	# Matrix
	<MaterialStart>
		ID              =  1      # phase id  [-]
		rho0            =  2700   # density - if dimensional [kg/m3]
		eta             =  1e24   # Viscosity - dimensional [Pa.s]
#		eta0            = 1e25
#		e0              = 1e-15
#		n               = 3
		shear           =  5e10
		cohesion        =  20e6
		friction        =  30
		frSoftID        =  0 # softening ID
		chSoftID        =  0
	<MaterialEnd>


	# sticky-air layer
	<MaterialStart>
		ID              = 2     # phase id  [-]
		rho0            = 100	# density - if dimensional [kg/m3]
		eta             = 1e21	# Viscosity - dimensional [Pa.s]
		shear           =  5e10
		cohesion        =  20e6
		friction        =  30
		frSoftID        =  0 # softening ID
		chSoftID        =  0
	<MaterialEnd>

# End of defining material properties for all phases ----------------------------------------
